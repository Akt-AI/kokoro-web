<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kokoro TTS — Single File (Vanilla, Fixed v2)</title>
  <style>
    :root { color-scheme: dark; }
    html,body { margin:0; padding:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica Neue, Arial, "Apple Color Emoji", "Segoe UI Emoji"; background:#0f172a; color:#e5e7eb }
    .wrap { max-width: 960px; margin: 0 auto; padding: 24px }
    .title { font-size: 32px; font-weight: 800; margin: 8px 0 4px }
    .sub { color:#cbd5e1; margin: 0 0 16px }
    .card { background: rgba(30,41,59,.6); border:1px solid #334155; border-radius: 14px; padding: 16px }
    textarea, select, button, input { font: inherit }
    textarea { width:100%; min-height:110px; max-height:280px; resize: vertical; color:#e5e7eb; background: rgba(15,23,42,.6); border:2px solid #334155; border-radius:12px; padding:10px }
    select { width:100%; color:#e5e7eb; background: rgba(15,23,42,.6); border:2px solid #334155; border-radius:12px; padding:10px; margin-top:10px }
    button.primary { padding:10px 18px; border-radius:12px; border:none; color:#fff; background: linear-gradient(180deg,#2563eb,#7c3aed); cursor:pointer }
    button.primary[disabled] { opacity:.6; cursor:not-allowed }
    button.ghost { padding:10px 14px; border-radius:12px; border:1px solid #334155; background: transparent; color:#e5e7eb; margin-left:8px; cursor:pointer }
    .results { margin-top: 18px; display: grid; gap: 12px }
    .result { position:relative; background: rgba(30,41,59,.7); border:1px solid #334155; border-radius: 12px; padding: 12px }
    .badge { position:absolute; top:8px; right:12px; font-size:12px; color:#cbd5e1 }
    .error { background: rgba(239,68,68,.15); border:1px solid rgba(239,68,68,.4); color:#fecaca; border-radius:10px; padding:10px; margin:12px 0 }
    .overlay { position: fixed; inset: 0; display:flex; align-items:center; justify-content:center; flex-direction:column; background: rgba(2,6,23,.88); backdrop-filter: blur(4px); z-index: 50 }
    .spinner { width: 220px; height: 220px; border-radius:50%; background:#2c74b3; box-shadow: inset 0 0 50px rgba(0,0,0,.5); border:4px solid #fff }
    .spinner::before, .spinner::after { content:""; position:absolute; width:200%; height:200%; top:0; left:50%; transform: translate(-50%,-75%); }
    .spinner::before { border-radius:45%; background: rgba(255,255,255,1); animation:spin1 5s linear infinite }
    .spinner::after { border-radius:40%; background: rgba(255,255,255,.5); animation:spin1 10s linear infinite }
    @keyframes spin1 { 0%{ transform: translate(-50%,-75%) rotate(0)} 100%{ transform: translate(-50%,-75%) rotate(360deg)} }
    details { margin-top: 18px }
    pre { white-space: pre-wrap }
    .muted { color:#94a3b8 }
    a { color:#93c5fd }
  </style>
</head>
<body>
  <div class="wrap">
    <div>
      <div class="title">Kokoro Text‑to‑Speech</div>
      <div class="sub">Runs locally in your browser using <a target="_blank" rel="noreferrer" href="https://github.com/hexgrad/kokoro">Kokoro</a> and <a target="_blank" rel="noreferrer" href="https://www.npmjs.com/package/kokoro-js">kokoro‑js</a>.</div>
    </div>

    <div id="error" class="error" style="display:none"></div>

    <div class="card">
      <label for="text" class="muted">Text</label>
      <textarea id="text">Life is like a box of chocolates. You never know what you're gonna get.</textarea>
      <label for="voice" class="muted">Voice</label>
      <select id="voice"><option>Loading voices…</option></select>
      <div style="margin-top:10px; display:flex; align-items:center">
        <button id="btn" class="primary">Generate</button>
        <button id="sample" class="ghost">Load sample</button>
      </div>
      <div id="hint" class="muted" style="margin-top:8px; font-size: 13px"></div>
    </div>

    <div id="results" class="results"></div>

    <details>
      <summary>Diagnostics</summary>
      <div style="margin-top:8px">
        <div>Device: <span id="d-device" class="muted">?</span></div>
        <div>Status: <span id="d-status" class="muted">boot</span></div>
        <div>Last error:</div>
        <pre id="d-error" class="muted">–</pre>
        <div>Recent messages:</div>
        <pre id="d-log" class="muted" style="max-height: 200px; overflow:auto"></pre>
      </div>
    </details>
  </div>

  <div id="overlay" class="overlay">
    <div class="spinner"></div>
    <p id="overlay-text" style="margin:16px 0 4px; font-size:20px">Loading model…</p>
    <p class="muted" style="font-size:13px">Tip: serve this file over http(s) — <code>python3 -m http.server 8000</code></p>
  </div>

  <script type="module">
    // ---- Utilities ----
    const $ = (sel) => document.querySelector(sel);
    const el = {
      error: $('#error'),
      text:  $('#text'),
      voice: $('#voice'),
      btn:   $('#btn'),
      sample:$('#sample'),
      results: $('#results'),
      overlay: $('#overlay'), overlayText: $('#overlay-text'),
      dDevice: $('#d-device'), dStatus: $('#d-status'), dError: $('#d-error'), dLog: $('#d-log'),
      hint: $('#hint'),
    };
    const log = (...a) => { console.log(...a); el.dLog.textContent = [String(a.join(' ')), el.dLog.textContent].filter(Boolean).slice(0,1000).join('\n'); };
    const setStatus = (s) => { el.dStatus.textContent = s };
    const showError = (msg) => { el.error.textContent = msg; el.error.style.display = 'block'; el.dError.textContent = msg; };
    const hideError = () => { el.error.style.display = 'none'; el.dError.textContent = '–'; };

    // Show hint if served from file://
    if (location.protocol === 'file:') {
      el.hint.textContent = 'You are opening this via file:// — some browsers block WASM. If it fails, use a local server.';
    } else {
      el.hint.textContent = '';
    }

    // ---- Worker (module) built from a Blob ----
    const workerURL = URL.createObjectURL(new Blob([`
      import { KokoroTTS } from 'https://cdn.jsdelivr.net/npm/kokoro-js@1.2.1/+esm';

      async function detectWebGPU() {
        try { const ad = await (navigator.gpu?.requestAdapter?.()); return !!ad; } catch { return false; }
      }

      async function init() {
        const devicePref = (await detectWebGPU()) ? 'webgpu' : 'wasm';
        self.postMessage({ status: 'device', device: devicePref });

        const model_id = 'onnx-community/Kokoro-82M-v1.0-ONNX';

        // Try preferred device first, then robust fallback to wasm q8
        let tts;
        try {
          tts = await KokoroTTS.from_pretrained(model_id, {
            dtype: devicePref === 'wasm' ? 'q8' : 'fp32',
            device: devicePref,
          });
        } catch (e1) {
          try {
            tts = await KokoroTTS.from_pretrained(model_id, { dtype: 'q8', device: 'wasm' });
          } catch (e2) {
            self.postMessage({ status: 'error', error: (e2 && e2.message) ? e2.message : String(e2) });
            return;
          }
        }

        const voices = (typeof tts.list_voices === 'function') ? tts.list_voices() : (tts.voices || {});
        self.postMessage({ status: 'ready', voices, device: tts.device || devicePref });

        self.addEventListener('message', async (e) => {
          const { text, voice } = e.data || {};
          try {
            const audio = await tts.generate(text, { voice });
            const blob = audio.toBlob();
            self.postMessage({ status: 'complete', audio: URL.createObjectURL(blob), text });
          } catch (err) {
            self.postMessage({ status: 'error', error: (err && err.message) ? err.message : String(err) });
          }
        });
      }

      init();
    `], { type: 'text/javascript' }));

    let worker;
    try {
      worker = new Worker(workerURL, { type: 'module' });
    } catch (e) {
      showError('Failed to start Worker: ' + (e?.message || e));
      setStatus('error');
    }

    // ---- Wire UI -> Worker ----
    el.btn.addEventListener('click', (e) => {
      e.preventDefault();
      const text = (el.text.value || '').trim();
      if (!text) return;
      el.btn.disabled = true; setStatus('running');
      worker?.postMessage({ text, voice: el.voice.value });
    });
    el.sample.addEventListener('click', (e) => {
      e.preventDefault();
      el.text.value = "Hello! This is Kokoro speaking from a single HTML file — running fully in your browser.";
    });

    // ---- Handle Worker messages ----
    worker?.addEventListener('message', (e) => {
      const msg = e.data || {}; log('worker:', JSON.stringify(msg));
      if (msg.status === 'device') {
        el.dDevice.textContent = msg.device || '?';
        setStatus('loading');
        el.overlayText.textContent = `Loading model (device="${msg.device}") …`;
      } else if (msg.status === 'ready') {
        setStatus('ready'); hideError(); el.overlay.style.display = 'none';
        // Populate voices
        const v = msg.voices || {};
        el.voice.innerHTML = '';
        const entries = Array.isArray(v) ? v.map((x,i)=>[x.id||x.name||`v${i}`, x]) : Object.entries(v);
        if (entries.length === 0) el.voice.innerHTML = '<option value="af_heart">af_heart</option>';
        else {
          for (const [id, info] of entries) {
            const opt = document.createElement('option');
            opt.value = id;
            const lang = (info && info.language) ? (info.language === 'en-us' ? 'American' : 'British') : 'Voice';
            const gender = (info && info.gender) ? info.gender : '';
            opt.textContent = `${info?.name || id} (${lang}${gender?(' '+gender):''})`;
            el.voice.appendChild(opt);
          }
          // prefer af_heart if present
          const opt = Array.from(el.voice.options).find(o=>o.value === 'af_heart');
          if (opt) el.voice.value = 'af_heart';
        }
      } else if (msg.status === 'error') {
        setStatus('error'); el.btn.disabled = false; showError(msg.error || 'Unknown error');
      } else if (msg.status === 'complete') {
        setStatus('ready'); el.btn.disabled = false; hideError();
        const div = document.createElement('div'); div.className = 'result';
        const idx = document.createElement('span'); idx.className = 'badge'; idx.textContent = '#' + (el.results.children.length + 1);
        const p = document.createElement('p'); p.textContent = msg.text; p.style.margin = '0 0 8px';
        const audio = document.createElement('audio'); audio.controls = true; audio.src = msg.audio; audio.style.width='100%';
        div.appendChild(idx); div.appendChild(p); div.appendChild(audio); el.results.prepend(div);
      }
    });

    worker?.addEventListener('error', (e) => {
      setStatus('error'); showError('Worker error: ' + (e.message || e));
    });
  </script>
</body>
</html>

